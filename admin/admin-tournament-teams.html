<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Pull Teams to Tournament | EduSportPro</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script src="/admin/admin-data-store.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          colors: {
            hope: {
              lime: '#8DC63F',
              cyan: '#00AEEF',
              red: '#ED1C24',
              yellow: '#FDC116',
              dark: '#1D1D1B',
              light: '#f2f4f7',
            }
          }
        }
      }
    }
  </script>

  <style>
    body {
      background-color: #f2f4f7;
      color: #1D1D1B;
      overflow-x: hidden;
    }

    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #00AEEF;
    }

    .glass-backdrop {
      background-color: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
    }
  </style>
</head>

<body class="antialiased h-screen flex flex-col">

  <nav class="bg-white w-full shadow-sm border-b border-gray-200 flex items-center justify-between px-4 md:px-6 py-3 sticky top-0 z-50 shrink-0">
    <div class="flex items-center gap-3">
      <div class="w-15 h-12 md:w-25 md:h-15 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden border border-gray-100 shadow-sm shrink-0">
        <img src="/images/logo.jpg" alt="Logo" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.innerHTML='<span class=\'text-[10px] font-bold text-gray-400\'>HOPE</span>'">
      </div>

      <div class="hidden sm:block">
        <div class="text-[10px] md:text-xs font-bold text-hope-dark uppercase tracking-tight leading-tight">
          Organization for Children's
        </div>
        <div class="text-xs md:text-sm font-extrabold text-hope-cyan leading-none">
          Hope Foundation of Cambodia
        </div>
      </div>
    </div>

    <div class="flex items-center gap-3 md:gap-6">
      <a href="/admin/admin-notifications.html" class="relative p-2 hover:bg-gray-100 rounded-full transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-hope-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
        </svg>
        <span class="absolute top-1 right-1 bg-hope-red text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border-2 border-white">4</span>
      </a>

      <select class="bg-gray-50 border border-gray-200 text-hope-dark text-sm rounded-lg focus:ring-hope-cyan focus:border-hope-cyan block px-2 py-1.5 md:px-3 outline-none">
        <option>EN</option>
        <option>KM</option>
      </select>

      <a href="/admin/admin-profile.html" class="flex items-center gap-2 md:gap-3 cursor-pointer pl-2 md:pl-4 border-l border-gray-200 hover:bg-gray-50 transition-colors rounded-r-lg p-1">
        <div class="text-right hidden md:block">
          <div class="text-sm font-semibold text-hope-dark">Admin User</div>
          <div class="text-xs text-gray-500">Super Admin</div>
        </div>
        <div class="w-8 h-8 md:w-9 md:h-9 bg-hope-cyan rounded-full flex items-center justify-center text-white font-bold border-2 border-white shadow-sm shrink-0">
          AU
        </div>
      </a>
    </div>
  </nav>

  <div class="flex h-[calc(100vh-64px)] relative overflow-hidden">
    <main class="flex-1 p-4 md:p-8 overflow-y-auto w-full">
      <div class="flex flex-col md:flex-row md:justify-between md:items-end gap-4 mb-6">
        <div>
          <a href="/admin/admin-tournament-overview.html" class="inline-flex items-center text-sm text-gray-500 hover:text-hope-cyan transition-colors mb-2">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            Back to Tournament
          </a>
          <h1 class="text-2xl md:text-3xl font-bold text-hope-dark">Pull Teams Into Tournament</h1>
          <p class="text-gray-500 mt-1 text-sm md:text-base">Select a tournament, choose teams, and assign them to competition groups.</p>
        </div>
        <div id="assignStatus" class="text-sm font-medium text-gray-500"></div>
      </div>

      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 md:p-6 mb-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div>
            <label for="tournamentSelect" class="block text-sm font-medium text-gray-700 mb-1">Tournament</label>
            <select id="tournamentSelect" class="w-full rounded-lg border-gray-300 border p-2.5 text-gray-900 focus:border-hope-cyan focus:ring-hope-cyan sm:text-sm shadow-sm outline-none"></select>
          </div>
          <div>
            <label for="divisionFilter" class="block text-sm font-medium text-gray-700 mb-1">Division Filter</label>
            <select id="divisionFilter" class="w-full rounded-lg border-gray-300 border p-2.5 text-gray-900 focus:border-hope-cyan focus:ring-hope-cyan sm:text-sm shadow-sm outline-none">
              <option value="">All Divisions</option>
              <option value="U12">U12</option>
              <option value="U14">U14</option>
              <option value="U16">U16</option>
              <option value="U18">U18</option>
            </select>
          </div>
          <div>
            <label for="teamSearch" class="block text-sm font-medium text-gray-700 mb-1">Search Team</label>
            <input id="teamSearch" type="text" placeholder="Type team name..." class="w-full rounded-lg border-gray-300 border p-2.5 text-gray-900 focus:border-hope-cyan focus:ring-hope-cyan sm:text-sm shadow-sm outline-none">
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
        <section class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 md:p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-bold text-hope-dark">Available Teams</h2>
            <button id="toggleAllBtn" class="text-xs px-3 py-1.5 rounded-md border border-gray-200 bg-gray-50 hover:bg-gray-100 text-gray-700">Select All</button>
          </div>
          <div id="availableTeamsList" class="space-y-2 max-h-[420px] overflow-y-auto pr-1"></div>
          <div class="mt-4 flex flex-wrap gap-2">
            <button id="assignSelectedBtn" class="px-4 py-2 rounded-lg bg-hope-cyan text-white text-sm font-semibold hover:bg-sky-500 transition-colors">Assign Selected Teams</button>
            <button id="clearSelectedBtn" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-700 text-sm font-semibold hover:bg-gray-200 transition-colors">Clear Selected</button>
          </div>
        </section>

        <section class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 md:p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-bold text-hope-dark">Assigned Teams</h2>
            <span id="assignedCount" class="text-xs px-2.5 py-1 rounded-full bg-hope-cyan/10 text-hope-cyan border border-hope-cyan/20">0 teams</span>
          </div>
          <div id="assignedTeamsList" class="space-y-2 max-h-[470px] overflow-y-auto pr-1"></div>
        </section>
      </div>

      <section class="rounded-2xl shadow-sm border border-hope-cyan/20 bg-gradient-to-br from-white via-cyan-50/30 to-emerald-50/20 p-5 md:p-6 mt-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-4">
          <h2 class="text-lg font-bold text-hope-dark">Tournament Component: Teams in Selected Tournament</h2>
          <div class="text-xs px-2 py-1 rounded-full bg-white/80 border border-gray-200 text-gray-600">Auto-updates when teams are assigned/removed</div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
          <div>
            <label for="tcSearch" class="block text-xs font-semibold text-gray-500 mb-1 uppercase tracking-wide">Search Team</label>
            <input id="tcSearch" type="text" placeholder="Search in selected tournament..." class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 outline-none focus:border-hope-cyan focus:ring-hope-cyan">
          </div>
          <div>
            <label for="tcDivision" class="block text-xs font-semibold text-gray-500 mb-1 uppercase tracking-wide">Division</label>
            <select id="tcDivision" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 outline-none focus:border-hope-cyan focus:ring-hope-cyan">
              <option value="">All Divisions</option>
              <option value="U12">U12</option>
              <option value="U14">U14</option>
              <option value="U16">U16</option>
              <option value="U18">U18</option>
            </select>
          </div>
          <div>
            <label for="tcCoach" class="block text-xs font-semibold text-gray-500 mb-1 uppercase tracking-wide">Coach</label>
            <select id="tcCoach" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 outline-none focus:border-hope-cyan focus:ring-hope-cyan">
              <option value="">All Coaches</option>
            </select>
          </div>
        </div>
        <div id="tournamentComponentSummary" class="flex flex-wrap gap-2 mb-5"></div>
        <div id="tournamentComponentList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </section>
    </main>
  </div>

  <script>
    let teams = [];
    let players = [];
    let coaches = [];
    let tournaments = [];
    let tournamentMap = {};

    function loadData() {
      teams = window.AdminDataStore.getArray('teams', []);
      players = window.AdminDataStore.getArray('players', []);
      coaches = window.AdminDataStore.getArray('coaches', []);
      tournaments = window.AdminDataStore.getArray('tournaments', []);
      tournamentMap = window.AdminDataStore.getObject('tournamentTeamMap', {});

      if (!Array.isArray(teams)) teams = [];
      if (!Array.isArray(players)) players = [];
      if (!Array.isArray(coaches)) coaches = [];
      if (!Array.isArray(tournaments)) tournaments = [];
      if (typeof tournamentMap !== 'object' || tournamentMap === null) tournamentMap = {};
    }

    function getTeamPlayerCount(team) {
      if (typeof team.playerCount === 'number') return team.playerCount;
      if (Array.isArray(team.players)) return team.players.length;

      return players.filter(function (player) {
        const directTeamId = player.teamId || player.team_id || player.teamID;
        const nestedTeamId = player.team && (player.team.id || player.team.teamId || player.team.team_id);
        const linkedTeamId = directTeamId || nestedTeamId;
        return linkedTeamId === team.id;
      }).length;
    }

    function getTeamCoachName(team) {
      if (team.coachName) return team.coachName;
      if (team.coach && (team.coach.name || team.coach.fullName)) return team.coach.name || team.coach.fullName;

      const coachId = team.coachId || team.coach_id || (team.coach && (team.coach.id || team.coach.coachId));
      if (!coachId) return 'Unassigned';

      const coach = coaches.find(function (c) {
        const id = c.id || c.coachId || c.coach_id;
        return id === coachId;
      });

      if (!coach) return 'Unassigned';
      return coach.name || coach.fullName || 'Unassigned';
    }

    function saveMap() {
      window.AdminDataStore.set('tournamentTeamMap', tournamentMap);
    }

    function currentTournamentId() {
      const select = document.getElementById('tournamentSelect');
      return select.value;
    }

    function currentAssignedIds() {
      const tId = currentTournamentId();
      if (!tId) return [];
      return tournamentMap[tId] || [];
    }

    function renderTournamentSelect() {
      const select = document.getElementById('tournamentSelect');
      if (!tournaments.length) {
        select.innerHTML = '<option value="">No tournaments found</option>';
        return;
      }
      select.innerHTML = tournaments.map(function (t) {
        return '<option value="' + t.id + '">' + t.name + '</option>';
      }).join('');
    }

    function teamCard(team, checked) {
      return (
        '<label class="flex items-center justify-between rounded-lg border border-gray-200 px-3 py-2 hover:border-hope-cyan/60 transition-colors cursor-pointer">' +
        '<span class="flex flex-col">' +
        '<span class="text-sm font-semibold text-hope-dark">' + team.name + '</span>' +
        '<span class="text-xs text-gray-500">' + team.id + ' | ' + team.division + '</span>' +
        '</span>' +
        '<input class="team-checkbox rounded border-gray-300 text-hope-cyan focus:ring-hope-cyan" type="checkbox" data-team-id="' + team.id + '"' + (checked ? ' checked' : '') + '>' +
        '</label>'
      );
    }

    function renderAvailableTeams() {
      const search = document.getElementById('teamSearch').value.trim().toLowerCase();
      const division = document.getElementById('divisionFilter').value;
      const assigned = new Set(currentAssignedIds());

      const filtered = teams.filter(function (team) {
        const byDivision = !division || team.division === division;
        const bySearch = !search || team.name.toLowerCase().includes(search) || team.id.toLowerCase().includes(search);
        return byDivision && bySearch && !assigned.has(team.id);
      });

      const list = document.getElementById('availableTeamsList');
      if (!filtered.length) {
        list.innerHTML = '<div class="text-sm text-gray-500 bg-gray-50 border border-dashed border-gray-200 rounded-lg p-4">No available teams for this filter.</div>';
        return;
      }

      list.innerHTML = filtered.map(function (team) {
        return teamCard(team, false);
      }).join('');
    }

    function renderAssignedTeams() {
      const ids = currentAssignedIds();
      const assignedTeams = ids.map(function (id) {
        return teams.find(function (team) { return team.id === id; });
      }).filter(Boolean);

      const list = document.getElementById('assignedTeamsList');
      const counter = document.getElementById('assignedCount');
      counter.textContent = assignedTeams.length + (assignedTeams.length === 1 ? ' team' : ' teams');

      if (!assignedTeams.length) {
        list.innerHTML = '<div class="text-sm text-gray-500 bg-gray-50 border border-dashed border-gray-200 rounded-lg p-4">No team has been assigned to this tournament yet.</div>';
        renderTournamentComponent([]);
        return;
      }

      list.innerHTML = assignedTeams.map(function (team) {
        return (
          '<div class="flex items-center justify-between rounded-lg border border-gray-200 px-3 py-2">' +
          '<span class="flex flex-col">' +
          '<span class="text-sm font-semibold text-hope-dark">' + team.name + '</span>' +
          '<span class="text-xs text-gray-500">' + team.id + ' | ' + team.division + '</span>' +
          '</span>' +
          '<button class="text-xs px-2 py-1 rounded-md bg-red-50 text-hope-red hover:bg-red-100 transition-colors" onclick="removeTeam(\'' + team.id + '\')">Remove</button>' +
          '</div>'
        );
      }).join('');

      renderTournamentComponent(assignedTeams);
    }

    function renderTournamentComponent(assignedTeams) {
      const list = document.getElementById('tournamentComponentList');
      const summary = document.getElementById('tournamentComponentSummary');
      const searchInput = document.getElementById('tcSearch');
      const divisionSelect = document.getElementById('tcDivision');
      const coachSelect = document.getElementById('tcCoach');

      const currentCoachFilter = coachSelect.value;
      const coachOptions = Array.from(new Set(assignedTeams.map(function (team) {
        return getTeamCoachName(team);
      }).filter(Boolean))).sort();

      coachSelect.innerHTML = '<option value="">All Coaches</option>' + coachOptions.map(function (coachName) {
        return '<option value="' + coachName + '">' + coachName + '</option>';
      }).join('');
      if (coachOptions.indexOf(currentCoachFilter) !== -1) {
        coachSelect.value = currentCoachFilter;
      }

      if (!assignedTeams.length) {
        summary.innerHTML = '<span class="text-xs px-2.5 py-1 rounded-full bg-white text-gray-600 border border-gray-200">0 teams</span>';
        list.innerHTML = '<div class="md:col-span-2 lg:col-span-3 text-sm text-gray-500 bg-white/80 border border-dashed border-gray-300 rounded-xl p-5">No teams are currently in this tournament.</div>';
        return;
      }

      const search = searchInput.value.trim().toLowerCase();
      const division = divisionSelect.value;
      const coach = coachSelect.value;
      const filteredTeams = assignedTeams.filter(function (team) {
        const coachName = getTeamCoachName(team);
        const bySearch = !search || team.name.toLowerCase().includes(search) || String(team.id).toLowerCase().includes(search);
        const byDivision = !division || team.division === division;
        const byCoach = !coach || coachName === coach;
        return bySearch && byDivision && byCoach;
      });

      const byDivision = filteredTeams.reduce(function (acc, team) {
        const key = team.division || 'N/A';
        acc[key] = (acc[key] || 0) + 1;
        return acc;
      }, {});
      const totalPlayers = filteredTeams.reduce(function (sum, team) {
        return sum + getTeamPlayerCount(team);
      }, 0);

      const summaryBadges = [
        '<span class="text-xs px-2.5 py-1 rounded-full bg-white text-hope-cyan border border-hope-cyan/30 shadow-sm">Showing: ' + filteredTeams.length + ' / ' + assignedTeams.length + ' teams</span>',
        '<span class="text-xs px-2.5 py-1 rounded-full bg-white text-hope-dark border border-hope-lime/40 shadow-sm">Total Players: ' + totalPlayers + '</span>'
      ];

      Object.keys(byDivision).sort().forEach(function (division) {
        summaryBadges.push('<span class="text-xs px-2.5 py-1 rounded-full bg-white text-gray-700 border border-gray-200 shadow-sm">' + division + ': ' + byDivision[division] + '</span>');
      });

      summary.innerHTML = summaryBadges.join('');

      if (!filteredTeams.length) {
        list.innerHTML = '<div class="md:col-span-2 lg:col-span-3 text-sm text-gray-500 bg-white/80 border border-dashed border-gray-300 rounded-xl p-5">No teams match this filter.</div>';
        return;
      }

      list.innerHTML = filteredTeams.map(function (team) {
        const playerCount = getTeamPlayerCount(team);
        const coachName = getTeamCoachName(team);
        const initials = team.name.split(' ').map(function (part) { return part.charAt(0); }).join('').slice(0, 2).toUpperCase();
        return (
          '<article class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm hover:shadow-md hover:border-hope-cyan/40 transition-all">' +
          '<div class="flex items-start justify-between gap-3">' +
          '<div class="flex items-center gap-3">' +
          '<div class="w-10 h-10 rounded-full bg-hope-cyan/10 text-hope-cyan border border-hope-cyan/20 flex items-center justify-center text-xs font-bold">' + initials + '</div>' +
          '<div>' +
          '<h3 class="text-sm font-semibold text-hope-dark leading-tight">' + team.name + '</h3>' +
          '<p class="text-[11px] text-gray-500 mt-0.5">Team ID: ' + team.id + '</p>' +
          '</div>' +
          '</div>' +
          '<span class="text-[11px] px-2 py-1 rounded-full bg-gray-100 text-gray-700 border border-gray-200">' + team.division + '</span>' +
          '</div>' +
          '<div class="mt-3 pt-3 border-t border-gray-100 grid grid-cols-2 gap-2">' +
          '<div class="rounded-lg bg-gray-50 px-2.5 py-2 border border-gray-100">' +
          '<p class="text-[10px] uppercase tracking-wide text-gray-500">Coach</p>' +
          '<p class="text-xs font-medium text-hope-dark truncate">' + coachName + '</p>' +
          '</div>' +
          '<div class="rounded-lg bg-gray-50 px-2.5 py-2 border border-gray-100">' +
          '<p class="text-[10px] uppercase tracking-wide text-gray-500">Players</p>' +
          '<p class="text-xs font-semibold text-hope-dark">' + playerCount + '</p>' +
          '</div>' +
          '</div>' +
          '</article>'
        );
      }).join('');
    }

    function rerenderTournamentComponentFromCurrent() {
      const ids = currentAssignedIds();
      const assignedTeams = ids.map(function (id) {
        return teams.find(function (team) { return team.id === id; });
      }).filter(Boolean);
      renderTournamentComponent(assignedTeams);
    }

    function setStatus(message, isError) {
      const status = document.getElementById('assignStatus');
      status.textContent = message;
      status.className = 'text-sm font-medium ' + (isError ? 'text-hope-red' : 'text-hope-cyan');
    }

    function assignSelected() {
      const tId = currentTournamentId();
      if (!tId) {
        setStatus('Please select a tournament first.', true);
        return;
      }
      const checkboxes = document.querySelectorAll('.team-checkbox:checked');
      const ids = Array.from(checkboxes).map(function (cb) { return cb.dataset.teamId; });
      if (!ids.length) {
        setStatus('Select at least one team first.', true);
        return;
      }

      const existing = new Set(tournamentMap[tId] || []);
      ids.forEach(function (id) { existing.add(id); });
      tournamentMap[tId] = Array.from(existing);
      saveMap();

      setStatus(ids.length + ' team(s) assigned successfully.', false);
      renderAvailableTeams();
      renderAssignedTeams();
    }

    function removeTeam(teamId) {
      const tId = currentTournamentId();
      if (!tId) return;
      const team = teams.find(function (item) { return item.id === teamId; });
      const teamName = team ? team.name : 'this team';
      const isConfirmed = window.confirm('Are you sure you want to remove ' + teamName + ' from Assigned Teams?');
      if (!isConfirmed) return;

      tournamentMap[tId] = (tournamentMap[tId] || []).filter(function (id) {
        return id !== teamId;
      });
      saveMap();
      setStatus('Team removed from tournament.', false);
      renderAvailableTeams();
      renderAssignedTeams();
    }

    function toggleAllAvailable() {
      const boxes = document.querySelectorAll('.team-checkbox');
      const allChecked = Array.from(boxes).every(function (box) { return box.checked; });
      boxes.forEach(function (box) { box.checked = !allChecked; });
    }

    function clearSelected() {
      document.querySelectorAll('.team-checkbox').forEach(function (box) {
        box.checked = false;
      });
      setStatus('Selection cleared.', false);
    }

    function bindEvents() {
      document.getElementById('tournamentSelect').addEventListener('change', function () {
        renderAvailableTeams();
        renderAssignedTeams();
        setStatus('', false);
      });
      document.getElementById('divisionFilter').addEventListener('change', renderAvailableTeams);
      document.getElementById('teamSearch').addEventListener('input', renderAvailableTeams);
      document.getElementById('assignSelectedBtn').addEventListener('click', assignSelected);
      document.getElementById('toggleAllBtn').addEventListener('click', toggleAllAvailable);
      document.getElementById('clearSelectedBtn').addEventListener('click', clearSelected);
      document.getElementById('tcSearch').addEventListener('input', rerenderTournamentComponentFromCurrent);
      document.getElementById('tcDivision').addEventListener('change', rerenderTournamentComponentFromCurrent);
      document.getElementById('tcCoach').addEventListener('change', rerenderTournamentComponentFromCurrent);
    }

    document.addEventListener('DOMContentLoaded', async function () {
      await window.AdminDataStore.bootstrap();
      loadData();
      renderTournamentSelect();
      bindEvents();
      renderAvailableTeams();
      renderAssignedTeams();
    });
  </script>
</body>

</html>
