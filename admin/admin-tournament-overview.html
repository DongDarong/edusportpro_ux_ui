<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Tournament Overview | EduSportPro</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script src="/admin/admin-data-store.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          colors: {
            hope: {
              lime: '#8DC63F',
              cyan: '#00AEEF',
              red: '#ED1C24',
              yellow: '#FDC116',
              dark: '#1D1D1B',
              light: '#f2f4f7',
            }
          }
        }
      }
    }
  </script>

  <style>
    body {
      background-color: #f2f4f7;
      color: #1D1D1B;
      overflow-x: hidden;
    }

    .glass-backdrop {
      background-color: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
    }
  </style>
</head>

<body class="antialiased h-screen flex flex-col">

  <nav class="bg-white w-full shadow-sm border-b border-gray-200 flex items-center justify-between px-4 md:px-6 py-3 sticky top-0 z-50 shrink-0">
    <div class="flex items-center gap-3">
      <button onclick="toggleSidebar()" class="md:hidden p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-hope-lime">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
      </button>

      <div class="w-15 h-12 md:w-25 md:h-15 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden border border-gray-100 shadow-sm shrink-0">
        <img src="/images/logo.jpg" alt="Logo" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.innerHTML='<span class=\'text-[10px] font-bold text-gray-400\'>HOPE</span>'">
      </div>

      <div class="hidden sm:block">
        <div class="text-[10px] md:text-xs font-bold text-hope-dark uppercase tracking-tight leading-tight">Organization for Children's</div>
        <div class="text-xs md:text-sm font-extrabold text-hope-cyan leading-none">Hope Foundation of Cambodia</div>
      </div>
    </div>

    <div class="flex items-center gap-3 md:gap-6">
      <a href="/admin/admin-notifications.html" class="relative p-2 hover:bg-gray-100 rounded-full transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-hope-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
        </svg>
        <span class="absolute top-1 right-1 bg-hope-red text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border-2 border-white">4</span>
      </a>

      <select class="bg-gray-50 border border-gray-200 text-hope-dark text-sm rounded-lg focus:ring-hope-cyan focus:border-hope-cyan block px-2 py-1.5 md:px-3 outline-none">
        <option>EN</option>
        <option>KM</option>
      </select>

      <a href="/admin/admin-profile.html" class="flex items-center gap-2 md:gap-3 cursor-pointer pl-2 md:pl-4 border-l border-gray-200 hover:bg-gray-50 transition-colors rounded-r-lg p-1">
        <div class="text-right hidden md:block">
          <div class="text-sm font-semibold text-hope-dark">Admin User</div>
          <div class="text-xs text-gray-500">Super Admin</div>
        </div>
        <div class="w-8 h-8 md:w-9 md:h-9 bg-hope-cyan rounded-full flex items-center justify-center text-white font-bold border-2 border-white shadow-sm shrink-0">AU</div>
      </a>
    </div>
  </nav>

  <div class="flex h-[calc(100vh-64px)] relative overflow-hidden">
    <div id="sidebarBackdrop" onclick="toggleSidebar()" class="fixed inset-0 glass-backdrop z-[55] hidden transition-opacity opacity-0 md:hidden"></div>
    <aside id="sidebar" data-active="tournament" class="w-64 bg-white shadow-xl md:shadow-md flex-shrink-0 z-[60] fixed inset-y-0 left-0 transform -translate-x-full transition-transform duration-300 md:translate-x-0 md:static md:z-auto h-full">
      <div class="p-5 h-full overflow-y-auto relative flex flex-col">
        <button onclick="toggleSidebar()" class="absolute top-4 right-4 md:hidden text-gray-400 hover:text-hope-red transition-colors p-1">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>

        <div class="mb-8 px-2">
          <div class="text-2xl font-extrabold tracking-tighter">
            <span class="text-hope-lime">Edu</span><span class="text-hope-cyan">Sport</span><span class="text-hope-red">Pro</span>
          </div>
        </div>

        <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 px-2">Main Menu</h2>
        <nav class="space-y-1 flex-1">
          <a class="flex items-center gap-3 py-2.5 px-4 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-hope-dark transition-colors group" href="/admin/admin-dashboard.html">
            <svg class="w-5 h-5 group-hover:text-hope-cyan transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            Dashboard
          </a>
          <a class="flex items-center gap-3 py-2.5 px-4 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-hope-dark transition-colors group" href="/admin/admin-users.html">
            <svg class="w-5 h-5 group-hover:text-hope-lime transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
            Users
          </a>
          <a class="flex items-center gap-3 py-2.5 px-4 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-hope-dark transition-colors group" href="/admin/admin-teams.html">
            <svg class="w-5 h-5 group-hover:text-hope-cyan transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
            Teams
          </a>
          <a class="flex items-center gap-3 py-2.5 px-4 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-hope-dark transition-colors group" href="/admin/admin-players.html">
            <svg class="w-5 h-5 group-hover:text-hope-red transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            Players
          </a>
          <a class="flex items-center gap-3 py-2.5 px-4 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-hope-dark transition-colors group" href="/admin/admin-matches.html">
            <svg class="w-5 h-5 group-hover:text-hope-yellow transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            Matches
          </a>
          <a class="flex items-center gap-3 py-2.5 px-4 rounded-lg bg-hope-cyan/10 text-hope-cyan font-semibold" href="/admin/admin-tournament-overview.html">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 21h8M12 17v4M7 4h10l-1 6H8L7 4zM5 4h14"></path></svg>
            Tournament
          </a>
          <a class="flex items-center gap-3 py-2.5 px-4 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-hope-dark transition-colors group" href="/admin/admin-division.html">
            <svg class="w-5 h-5 group-hover:text-hope-cyan transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18M3 12h18M3 17h18"></path></svg>
            Division
          </a>
          <a class="flex items-center gap-3 py-2.5 px-4 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-hope-dark transition-colors group" href="/admin/admin-training.html">
            <svg class="w-5 h-5 group-hover:text-hope-red transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            Training
          </a>
          <a class="flex items-center gap-3 py-2.5 px-4 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-hope-dark transition-colors group" href="/admin/admin-att.html">
            <svg class="w-5 h-5 group-hover:text-hope-lime transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
            Attendance
          </a>
          <a class="flex items-center gap-3 py-2.5 px-4 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-hope-dark transition-colors group" href="/admin/admin-calendar.html">
            <svg class="w-5 h-5 group-hover:text-hope-cyan transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            Calendar
          </a>

          <div class="pt-4 pb-2">
            <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider px-2">Management</h2>
          </div>

          <a class="flex items-center gap-3 py-2.5 px-4 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-hope-dark transition-colors group" href="/admin/admin-performance.html">
            <svg class="w-5 h-5 group-hover:text-hope-cyan transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
            Performance
          </a>
          <a class="flex items-center gap-3 py-2.5 px-4 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-hope-dark transition-colors group" href="/admin/admin-inventory.html">
            <svg class="w-5 h-5 group-hover:text-hope-lime transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
            Inventory
          </a>
          <a class="flex items-center gap-3 py-2.5 px-4 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-hope-dark transition-colors group" href="/admin/admin-reports.html">
            <svg class="w-5 h-5 group-hover:text-hope-cyan transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
            Reports
          </a>
        </nav>

        <div class="mt-auto pt-6 border-t border-gray-100">
          <a href="/index.html" class="flex items-center gap-3 py-2.5 px-4 rounded-lg text-hope-red hover:bg-red-50 transition-colors font-semibold">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7"></path></svg>
            Sign Out
          </a>
        </div>
      </div>
    </aside>

    <main class="flex-1 p-4 md:p-8 lg:p-10 overflow-y-auto w-full">
      <div class="rounded-2xl border border-hope-cyan/20 bg-gradient-to-br from-white via-cyan-50/40 to-emerald-50/30 p-5 md:p-6 mb-6">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
          <div>
            <p class="text-xs font-semibold uppercase tracking-wider text-hope-cyan mb-1">Analytics</p>
            <h1 class="text-2xl md:text-3xl font-bold text-hope-dark">Tournament Overview</h1>
            <p class="text-gray-600 mt-1 text-sm md:text-base">Filter tournaments and view team/player ranking performance.</p>
          </div>
          <div class="text-xs px-3 py-1.5 rounded-full bg-white border border-hope-cyan/20 text-hope-cyan font-semibold">Live from local data</div>
        </div>
      </div>

      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6">
        <div>
          <h2 class="text-xl md:text-2xl font-bold text-hope-dark">Tournament Pages</h2>
          <p class="text-gray-500 mt-1 text-sm md:text-base">Quick shortcuts for tournament administration workflows.</p>
        </div>
        <div class="w-full md:w-auto flex gap-2">
          <a href="/admin/create-tournament.html" class="w-full md:w-auto inline-flex justify-center items-center bg-hope-cyan hover:bg-sky-500 text-white px-5 py-2.5 rounded-lg shadow-sm transition-all font-medium">Create Tournament</a>
          <a href="/admin/admin-tournament-teams.html" class="w-full md:w-auto inline-flex justify-center items-center bg-hope-yellow hover:bg-amber-400 text-hope-dark px-5 py-2.5 rounded-lg shadow-sm transition-all font-medium">Pull Teams</a>
        </div>
      </div>

      <section class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 md:p-6 mb-6">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-5">
          <div>
            <h2 class="text-xl font-bold text-hope-dark">Tournament Ranking Overview</h2>
            <p class="text-sm text-gray-500 mt-1">Filter and review tournament count, team score ranking, and top 10 players.</p>
          </div>
          <div id="overviewScopeLabel" class="text-xs px-2.5 py-1 rounded-full bg-hope-cyan/10 text-hope-cyan border border-hope-cyan/20">Scope: All Tournaments</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-5 p-4 rounded-xl border border-gray-100 bg-gray-50/70">
          <div class="bg-white rounded-lg border border-gray-100 p-3.5">
            <label for="ovTournamentFilter" class="block text-sm font-medium text-gray-700 mb-1">Tournament Filter</label>
            <select id="ovTournamentFilter" class="w-full rounded-lg border-gray-300 border p-2.5 text-gray-900 focus:border-hope-cyan focus:ring-hope-cyan sm:text-sm shadow-sm outline-none"></select>
          </div>
          <div class="bg-white rounded-lg border border-gray-100 p-3.5">
            <label for="ovDivisionFilter" class="block text-sm font-medium text-gray-700 mb-1">Division Filter</label>
            <select id="ovDivisionFilter" class="w-full rounded-lg border-gray-300 border p-2.5 text-gray-900 focus:border-hope-cyan focus:ring-hope-cyan sm:text-sm shadow-sm outline-none">
              <option value="">All Divisions</option>
              <option value="U12">U12</option>
              <option value="U14">U14</option>
              <option value="U16">U16</option>
              <option value="U18">U18</option>
            </select>
          </div>
          <div class="flex items-end">
            <button id="ovRefreshBtn" class="w-full rounded-lg bg-hope-dark hover:bg-black text-white font-semibold px-4 py-2.5 transition-colors">Refresh Overview</button>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
          <div class="bg-gradient-to-br from-cyan-50 to-white rounded-xl p-4 border border-hope-cyan/20">
            <p class="text-xs text-gray-500 uppercase">Total Tournaments</p>
            <p id="ovTotalTournaments" class="text-2xl font-bold text-hope-dark mt-1">0</p>
          </div>
          <div class="bg-gradient-to-br from-lime-50 to-white rounded-xl p-4 border border-hope-lime/20">
            <p class="text-xs text-gray-500 uppercase">Total Teams In Scope</p>
            <p id="ovTotalTeams" class="text-2xl font-bold text-hope-dark mt-1">0</p>
          </div>
          <div class="bg-gradient-to-br from-yellow-50 to-white rounded-xl p-4 border border-hope-yellow/30">
            <p class="text-xs text-gray-500 uppercase">Players With Scores</p>
            <p id="ovTotalScoredPlayers" class="text-2xl font-bold text-hope-dark mt-1">0</p>
          </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
          <div class="rounded-xl border border-gray-100 p-4">
            <h3 class="text-base font-bold text-hope-dark mb-3">Team Scores (Highest First)</h3>
            <div class="overflow-x-auto rounded-lg border border-gray-100">
              <table class="min-w-full">
                <thead>
                  <tr class="bg-gray-50/90 border-b border-gray-200">
                    <th class="py-2.5 px-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Rank</th>
                    <th class="py-2.5 px-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Team</th>
                    <th class="py-2.5 px-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Division</th>
                    <th class="py-2.5 px-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Score</th>
                  </tr>
                </thead>
                <tbody id="ovTeamScoreBody" class="divide-y divide-gray-100"></tbody>
              </table>
            </div>
          </div>
          <div class="rounded-xl border border-gray-100 p-4">
            <h3 class="text-base font-bold text-hope-dark mb-3">Top Players (Up To 10)</h3>
            <div class="overflow-x-auto rounded-lg border border-gray-100">
              <table class="min-w-full">
                <thead>
                  <tr class="bg-gray-50/90 border-b border-gray-200">
                    <th class="py-2.5 px-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Rank</th>
                    <th class="py-2.5 px-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Player</th>
                    <th class="py-2.5 px-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Team</th>
                    <th class="py-2.5 px-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Score</th>
                  </tr>
                </thead>
                <tbody id="ovTopPlayersBody" class="divide-y divide-gray-100"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    let tournaments = [];
    let teams = [];
    let players = [];
    let tournamentMap = {};

    function loadOverviewData() {
      tournaments = window.AdminDataStore.getArray('tournaments', []);
      teams = window.AdminDataStore.getArray('teams', []);
      players = window.AdminDataStore.getArray('players', []);
      tournamentMap = window.AdminDataStore.getObject('tournamentTeamMap', {});

      if (!Array.isArray(tournaments)) tournaments = [];
      if (!Array.isArray(teams)) teams = [];
      if (!Array.isArray(players)) players = [];
      if (typeof tournamentMap !== 'object' || tournamentMap === null) tournamentMap = {};
    }

    function getTournamentNameById(id) {
      const found = tournaments.find(function (t) { return t.id === id; });
      return found ? found.name : id;
    }

    function getTeamById(id) {
      return teams.find(function (t) { return t.id === id; }) || null;
    }

    function getTeamNameById(id) {
      const team = getTeamById(id);
      return team ? (team.name || id) : id;
    }

    function getTeamDivisionById(id) {
      const team = getTeamById(id);
      return team ? (team.division || '-') : '-';
    }

    function asNumber(value) {
      const n = Number(value);
      return Number.isFinite(n) ? n : 0;
    }

    function getPlayerTeamId(player) {
      return player.teamId || player.team_id || player.teamID || (player.team && (player.team.id || player.team.teamId || player.team.team_id)) || '';
    }

    function getPlayerName(player) {
      return player.name || player.fullName || [player.firstName, player.lastName].filter(Boolean).join(' ') || (player.id || 'Unknown Player');
    }

    function getPlayerScore(player) {
      const stats = player.stats || {};
      const candidates = [
        player.score, player.totalScore, player.points, player.totalPoints, player.goals, player.goal,
        stats.score, stats.totalScore, stats.points, stats.totalPoints, stats.goals, stats.goal
      ];
      for (let i = 0; i < candidates.length; i++) {
        const n = asNumber(candidates[i]);
        if (n > 0) return n;
      }
      return 0;
    }

    function getTeamBaseScore(teamId) {
      const team = getTeamById(teamId);
      if (!team) return 0;
      const candidates = [team.score, team.totalScore, team.points, team.totalPoints, team.goals, team.goal];
      for (let i = 0; i < candidates.length; i++) {
        const n = asNumber(candidates[i]);
        if (n > 0) return n;
      }
      return 0;
    }

    function getSelectedTournamentId() {
      return document.getElementById('ovTournamentFilter').value;
    }

    function getSelectedDivision() {
      return document.getElementById('ovDivisionFilter').value;
    }

    function getTournamentTeamIds(tournamentId) {
      if (tournamentId === 'all') {
        const allIds = Object.keys(tournamentMap).reduce(function (acc, key) {
          const ids = Array.isArray(tournamentMap[key]) ? tournamentMap[key] : [];
          return acc.concat(ids);
        }, []);
        return Array.from(new Set(allIds));
      }
      const ids = tournamentMap[tournamentId];
      return Array.isArray(ids) ? Array.from(new Set(ids)) : [];
    }

    function populateTournamentFilter() {
      const select = document.getElementById('ovTournamentFilter');
      const options = ['<option value="all">All Tournaments</option>'].concat(
        tournaments.map(function (t) {
          return '<option value="' + t.id + '">' + t.name + '</option>';
        })
      );
      select.innerHTML = options.join('');
    }

    function renderEmptyState(tbodyId, colspan, message) {
      document.getElementById(tbodyId).innerHTML = '<tr><td colspan="' + colspan + '" class="py-4 px-3 text-sm text-gray-500 bg-gray-50/70">' + message + '</td></tr>';
    }

    function renderOverviewMetrics() {
      const selectedTournamentId = getSelectedTournamentId();
      const selectedDivision = getSelectedDivision();
      const teamIds = getTournamentTeamIds(selectedTournamentId);

      const filteredTeamIds = teamIds.filter(function (teamId) {
        if (!selectedDivision) return true;
        return getTeamDivisionById(teamId) === selectedDivision;
      });

      const teamIdSet = new Set(filteredTeamIds);
      const scopedPlayers = players.filter(function (player) {
        const teamId = getPlayerTeamId(player);
        return teamIdSet.has(teamId);
      });

      const tournamentsCount = selectedTournamentId === 'all' ? tournaments.length : (getTournamentNameById(selectedTournamentId) ? 1 : 0);
      document.getElementById('ovTotalTournaments').textContent = String(tournamentsCount);
      document.getElementById('ovTotalTeams').textContent = String(filteredTeamIds.length);
      document.getElementById('ovTotalScoredPlayers').textContent = String(scopedPlayers.filter(function (p) { return getPlayerScore(p) > 0; }).length);

      const scopeLabel = selectedTournamentId === 'all'
        ? 'Scope: All Tournaments'
        : 'Scope: ' + getTournamentNameById(selectedTournamentId);
      document.getElementById('overviewScopeLabel').textContent = scopeLabel + (selectedDivision ? ' | ' + selectedDivision : '');

      const teamScores = filteredTeamIds.map(function (teamId) {
        const sumPlayerScore = scopedPlayers
          .filter(function (player) { return getPlayerTeamId(player) === teamId; })
          .reduce(function (sum, player) { return sum + getPlayerScore(player); }, 0);
        const totalScore = sumPlayerScore > 0 ? sumPlayerScore : getTeamBaseScore(teamId);
        return {
          teamId: teamId,
          name: getTeamNameById(teamId),
          division: getTeamDivisionById(teamId),
          score: totalScore
        };
      }).sort(function (a, b) {
        if (b.score !== a.score) return b.score - a.score;
        return a.name.localeCompare(b.name);
      });

      const teamScoreBody = document.getElementById('ovTeamScoreBody');
      if (!teamScores.length) {
        renderEmptyState('ovTeamScoreBody', 4, 'No teams found for current filter.');
      } else {
        teamScoreBody.innerHTML = teamScores.map(function (row, idx) {
          return (
            '<tr class="hover:bg-gray-50 transition-colors">' +
            '<td class="py-2.5 px-3 text-sm text-gray-700">' + (idx + 1) + '</td>' +
            '<td class="py-2.5 px-3 text-sm font-semibold text-hope-dark">' + row.name + '</td>' +
            '<td class="py-2.5 px-3 text-sm text-gray-600">' + row.division + '</td>' +
            '<td class="py-2.5 px-3 text-sm font-bold text-hope-cyan">' + row.score + '</td>' +
            '</tr>'
          );
        }).join('');
      }

      const topPlayers = scopedPlayers
        .map(function (player) {
          return {
            name: getPlayerName(player),
            teamId: getPlayerTeamId(player),
            score: getPlayerScore(player)
          };
        })
        .filter(function (p) { return p.score > 0; })
        .sort(function (a, b) {
          if (b.score !== a.score) return b.score - a.score;
          return a.name.localeCompare(b.name);
        })
        .slice(0, 10);

      const playersBody = document.getElementById('ovTopPlayersBody');
      if (!topPlayers.length) {
        renderEmptyState('ovTopPlayersBody', 4, 'No player scores found for current filter.');
      } else {
        playersBody.innerHTML = topPlayers.map(function (row, idx) {
          return (
            '<tr class="hover:bg-gray-50 transition-colors">' +
            '<td class="py-2.5 px-3 text-sm text-gray-700">' + (idx + 1) + '</td>' +
            '<td class="py-2.5 px-3 text-sm font-semibold text-hope-dark">' + row.name + '</td>' +
            '<td class="py-2.5 px-3 text-sm text-gray-600">' + getTeamNameById(row.teamId) + '</td>' +
            '<td class="py-2.5 px-3 text-sm font-bold text-hope-cyan">' + row.score + '</td>' +
            '</tr>'
          );
        }).join('');
      }
    }

    function bindOverviewEvents() {
      document.getElementById('ovTournamentFilter').addEventListener('change', renderOverviewMetrics);
      document.getElementById('ovDivisionFilter').addEventListener('change', renderOverviewMetrics);
      document.getElementById('ovRefreshBtn').addEventListener('click', function () {
        loadOverviewData();
        populateTournamentFilter();
        renderOverviewMetrics();
      });
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const backdrop = document.getElementById('sidebarBackdrop');
      const body = document.body;

      if (sidebar.classList.contains('-translate-x-full')) {
        sidebar.classList.remove('-translate-x-full');
        backdrop.classList.remove('hidden');
        setTimeout(() => backdrop.classList.remove('opacity-0'), 10);
        body.style.overflow = 'hidden';
      } else {
        sidebar.classList.add('-translate-x-full');
        backdrop.classList.add('opacity-0');
        setTimeout(() => backdrop.classList.add('hidden'), 300);
        body.style.overflow = 'auto';
      }
    }

    document.addEventListener('DOMContentLoaded', async function () {
      await window.AdminDataStore.bootstrap();
      loadOverviewData();
      populateTournamentFilter();
      bindOverviewEvents();
      renderOverviewMetrics();
    });
  </script>
  <script src="/admin/admin-sidebar-loader.js"></script>
</body>

</html>
